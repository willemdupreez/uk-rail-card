{"version":3,"file":"uk-rail-card.js","sources":["../src/uk-rail-card.ts"],"sourcesContent":["interface RailCardConfig {\n  type: string;\n  title?: string;\n  device: string;\n  device_id?: string;\n}\n\ntype HomeAssistant = {\n  states: Record<\n    string,\n    { state: string; attributes: Record<string, unknown> }\n  >;\n  callWS?: <T>(message: Record<string, unknown>) => Promise<T>;\n};\n\ntype EntityRegistryEntry = {\n  entity_id: string;\n  device_id?: string | null;\n};\n\nconst version = '__VERSION__';\n\nconsole.info(\n  '%c UK-RAIL-CARD %c v'.concat(version, ' '),\n  'color: white; background: navy; font-weight: 700;',\n  'color: navy; background: white; font-weight: 700;'\n);\n\nclass UkRailCard extends HTMLElement {\n  private _config?: RailCardConfig;\n  private _hass?: HomeAssistant;\n  private _entityRegistry?: EntityRegistryEntry[];\n  private _entityRegistryLoaded = false;\n\n  constructor() {\n    super();\n    this.attachShadow({ mode: 'open' });\n  }\n\n  static getStubConfig(): RailCardConfig {\n    return {\n      type: 'custom:uk-rail-card',\n      title: 'Rail Services',\n      device: 'rail_station',\n    };\n  }\n\n  static getConfigElement(): HTMLElement {\n    return document.createElement('uk-rail-card-editor');\n  }\n\n  setConfig(config: RailCardConfig): void {\n    if (!config.device) {\n      throw new Error('You must define a device');\n    }\n\n    this._config = config;\n    void this.loadEntityRegistry();\n    this.render();\n  }\n\n  set hass(hass: HomeAssistant) {\n    this._hass = hass;\n    void this.loadEntityRegistry();\n    this.render();\n  }\n\n  getCardSize(): number {\n    return 3;\n  }\n\n  private async loadEntityRegistry(): Promise<void> {\n    if (\n      this._entityRegistryLoaded ||\n      !this._hass?.callWS ||\n      !this._config?.device_id\n    ) {\n      return;\n    }\n\n    this._entityRegistryLoaded = true;\n\n    try {\n      this._entityRegistry = await this._hass.callWS<EntityRegistryEntry[]>({\n        type: 'config/entity_registry/list',\n      });\n    } catch {\n      this._entityRegistry = [];\n    }\n\n    this.render();\n  }\n\n  private findEntityId(suffix: string): string | undefined {\n    if (!this._hass) {\n      return undefined;\n    }\n\n    const entityIds = Object.keys(this._hass.states);\n\n    if (this._config?.device_id) {\n      if (!this._entityRegistryLoaded) {\n        void this.loadEntityRegistry();\n        return undefined;\n      }\n\n      const deviceEntities = (this._entityRegistry ?? []).filter(\n        (entity) => entity.device_id === this._config?.device_id\n      );\n      const deviceEntityIds = deviceEntities.map(\n        (entity) => entity.entity_id\n      );\n      const scopedIds = entityIds.filter((entityId) =>\n        deviceEntityIds.includes(entityId)\n      );\n\n      return scopedIds.find((entityId) => entityId.endsWith(suffix));\n    }\n\n    return entityIds.find((entityId) => entityId.endsWith(suffix));\n  }\n\n  private getEntityState(entityId?: string): string {\n    if (!entityId || !this._hass) {\n      return '';\n    }\n\n    return this._hass.states[entityId]?.state ?? '';\n  }\n\n  private render(): void {\n    if (!this.shadowRoot || !this._config || !this._hass) {\n      return;\n    }\n\n    const deviceSuffix = this._config.device;\n    const maxEntityId =\n      this.findEntityId(`${deviceSuffix}_max_services`) ||\n      this.findEntityId('max_services');\n    const maxServices = Number(this.getEntityState(maxEntityId)) || 0;\n    const lastUpdatedEntityId =\n      this.findEntityId(`${deviceSuffix}_last_updated`) ||\n      this.findEntityId('last_updated');\n    const lastUpdated = this.getEntityState(lastUpdatedEntityId);\n    const lastUpdatedDate = lastUpdated ? new Date(lastUpdated) : null;\n    const lastUpdatedIso =\n      lastUpdatedDate && !Number.isNaN(lastUpdatedDate.getTime())\n        ? lastUpdatedDate.toISOString()\n        : '';\n\n    const rows: Array<{\n      scheduled: string;\n      destination: string;\n      estimated: string;\n    }> = [];\n\n    for (let index = 1; index <= maxServices; index += 1) {\n      const destinationId =\n        this.findEntityId(`${deviceSuffix}_${index}_destination`) ||\n        this.findEntityId(`${index}_destination`);\n\n      console.log(`Entity ID: ${destinationId}`);\n\n      const destination = this.getEntityState(destinationId).trim();\n\n      if (!destination) {\n        break;\n      }\n\n      const scheduledId =\n        this.findEntityId(`${deviceSuffix}_${index}_scheduled_time`) ||\n        this.findEntityId(`${index}_scheduled_time`);\n      const estimatedId =\n        this.findEntityId(`${deviceSuffix}_${index}_estimated_time`) ||\n        this.findEntityId(`${index}_estimated_time`);\n\n      rows.push({\n        scheduled: this.getEntityState(scheduledId) || '-',\n        destination,\n        estimated: this.getEntityState(estimatedId) || '-',\n      });\n    }\n\n    const title = this._config.title?.trim();\n\n    this.shadowRoot.innerHTML = `\n      <style>\n        :host {\n          display: block;\n        }\n\n        ha-card {\n          overflow: hidden;\n        }\n\n        .header {\n          padding: 16px 16px 0 16px;\n        }\n\n        .title {\n          font-size: 1.1rem;\n          font-weight: 600;\n          line-height: 1.4;\n        }\n\n        .table {\n          display: grid;\n          grid-template-columns: minmax(70px, 0.8fr) 2fr minmax(70px, 0.8fr);\n          gap: 4px 12px;\n          padding: 16px;\n        }\n\n        .head {\n          font-size: 0.75rem;\n          letter-spacing: 0.06em;\n          text-transform: uppercase;\n          color: var(--secondary-text-color);\n        }\n\n        .row {\n          display: contents;\n          font-size: 0.95rem;\n        }\n\n        .cell {\n          padding: 4px 0;\n          border-bottom: 1px solid rgba(0, 0, 0, 0.08);\n        }\n\n        .row:last-of-type .cell {\n          border-bottom: none;\n        }\n\n        .empty {\n          padding: 16px;\n          color: var(--secondary-text-color);\n          font-style: italic;\n        }\n\n        .status {\n          padding: 8px 16px 16px;\n          font-size: 0.8rem;\n          color: var(--secondary-text-color);\n        }\n      </style>\n      <ha-card>\n        ${\n          title\n            ? `<div class=\"header\"><div class=\"title\">${title}</div></div>`\n            : ''\n        }\n        ${\n          rows.length\n            ? `\n              <div class=\"table\">\n                <div class=\"head\">Scheduled</div>\n                <div class=\"head\">Destination</div>\n                <div class=\"head\">Estimated</div>\n                ${rows\n                  .map(\n                    (row) => `\n                      <div class=\"row\">\n                        <div class=\"cell\">${row.scheduled}</div>\n                        <div class=\"cell\">${row.destination}</div>\n                        <div class=\"cell\">${row.estimated}</div>\n                      </div>\n                    `\n                  )\n                  .join('')}\n              </div>\n            `\n            : `<div class=\"empty\">No services available.</div>`\n        }\n        ${\n          lastUpdatedIso\n            ? `\n              <div class=\"status\">\n                Last updated: <ha-relative-time></ha-relative-time>\n              </div>\n            `\n            : ''\n        }\n      </ha-card>\n    `;\n\n    if (lastUpdatedIso) {\n      const relativeTime = this.shadowRoot.querySelector('ha-relative-time') as\n        | (HTMLElement & { hass?: HomeAssistant; datetime?: string })\n        | null;\n\n      if (relativeTime) {\n        relativeTime.hass = this._hass;\n        relativeTime.datetime = lastUpdatedIso;\n      }\n    }\n  }\n}\n\nclass UkRailCardEditor extends HTMLElement {\n  private _config?: RailCardConfig;\n  private _hass?: HomeAssistant;\n  private _entities?: EntityRegistryEntry[];\n  private _entitiesLoaded = false;\n\n  constructor() {\n    super();\n    this.attachShadow({ mode: 'open' });\n  }\n\n  setConfig(config: RailCardConfig): void {\n    this._config = { ...config };\n    this.render();\n  }\n\n  set hass(hass: HomeAssistant) {\n    this._hass = hass;\n    void this.loadEntities();\n    this.render();\n  }\n\n  private updateConfigValue(key: keyof RailCardConfig, value: string): void {\n    if (!this._config) {\n      return;\n    }\n\n    const nextConfig: RailCardConfig = { ...this._config };\n    const trimmed = value.trim();\n\n    if (key === 'title') {\n      if (trimmed) {\n        nextConfig.title = trimmed;\n      } else {\n        delete nextConfig.title;\n      }\n    } else if (key === 'device') {\n      nextConfig.device = trimmed;\n    } else if (key === 'device_id') {\n      if (trimmed) {\n        nextConfig.device_id = trimmed;\n      } else {\n        delete nextConfig.device_id;\n      }\n    } else {\n      nextConfig[key] = value;\n    }\n\n    this._config = nextConfig;\n    this.dispatchEvent(\n      new CustomEvent('config-changed', {\n        detail: { config: nextConfig },\n        bubbles: true,\n        composed: true,\n      })\n    );\n  }\n\n  private async loadEntities(): Promise<void> {\n    if (this._entitiesLoaded || !this._hass?.callWS) {\n      return;\n    }\n\n    this._entitiesLoaded = true;\n\n    try {\n      this._entities = await this._hass.callWS<EntityRegistryEntry[]>({\n        type: 'config/entity_registry/list',\n      });\n    } catch {\n      this._entities = [];\n    }\n  }\n\n  private updateFormData(\n    form: HTMLElement & { data?: Record<string, unknown> }\n  ) {\n    const nextData = {\n      title: this._config?.title ?? '',\n      device_id: this._config?.device_id ?? '',\n    };\n    const current = form.data as\n      | { title?: string; device_id?: string }\n      | undefined;\n\n    if (\n      current?.title === nextData.title &&\n      current?.device_id === nextData.device_id\n    ) {\n      return;\n    }\n\n    form.data = nextData;\n  }\n\n  private deriveDeviceSuffix(entityId: string): string {\n    const entityName = entityId.split('.')[1] ?? '';\n\n    if (entityName.endsWith('_max_services')) {\n      return entityName.replace(/_max_services$/, '');\n    }\n\n    const match = entityName.match(\n      /^(.*)_\\d+_(scheduled_time|destination|estimated_time)$/\n    );\n\n    if (match) {\n      return match[1];\n    }\n\n    return entityName;\n  }\n\n  private pickEntityIdForDevice(deviceId: string): string | undefined {\n    const entities = (this._entities ?? []).filter(\n      (entity) => entity.device_id === deviceId\n    );\n    const entityIds = entities.map((entity) => entity.entity_id);\n\n    const maxServices = entityIds.find((entityId) =>\n      (entityId.split('.')[1] ?? '').endsWith('_max_services')\n    );\n\n    if (maxServices) {\n      return maxServices;\n    }\n\n    const matching = entityIds.find((entityId) =>\n      /^(.*)_\\d+_(scheduled_time|destination|estimated_time)$/.test(\n        entityId.split('.')[1] ?? ''\n      )\n    );\n\n    return matching ?? entityIds[0];\n  }\n\n  private updateDeviceFromDevice(deviceId: string): void {\n    if (!this._config) {\n      return;\n    }\n\n    const trimmed = deviceId.trim();\n\n    if (trimmed && !this._entitiesLoaded) {\n      void this.loadEntities().then(() => this.updateDeviceFromDevice(trimmed));\n      return;\n    }\n\n    const nextConfig: RailCardConfig = { ...this._config };\n\n    if (trimmed) {\n      nextConfig.device_id = trimmed;\n      const entityId = this.pickEntityIdForDevice(trimmed);\n      nextConfig.device = entityId ? this.deriveDeviceSuffix(entityId) : '';\n    } else {\n      delete nextConfig.device_id;\n      nextConfig.device = '';\n    }\n\n    this._config = nextConfig;\n    this.dispatchEvent(\n      new CustomEvent('config-changed', {\n        detail: { config: nextConfig },\n        bubbles: true,\n        composed: true,\n      })\n    );\n  }\n\n  private render(): void {\n    if (!this.shadowRoot) {\n      return;\n    }\n\n    const form = this.shadowRoot.querySelector('ha-form') as\n      | (HTMLElement & {\n          hass?: HomeAssistant;\n          data?: Record<string, unknown>;\n          schema?: Array<Record<string, unknown>>;\n          computeLabel?: (schema: { name: string }) => string;\n          computeHelper?: (schema: { name: string }) => string;\n        })\n      | null;\n\n    if (!form) {\n      this.shadowRoot.innerHTML = `\n        <style>\n          :host {\n            display: block;\n            padding: 8px 0;\n          }\n        </style>\n        <ha-form></ha-form>\n      `;\n    }\n\n    const resolvedForm = (this.shadowRoot.querySelector('ha-form') as\n      | (HTMLElement & {\n          hass?: HomeAssistant;\n          data?: Record<string, unknown>;\n          schema?: Array<Record<string, unknown>>;\n          computeLabel?: (schema: { name: string }) => string;\n          computeHelper?: (schema: { name: string }) => string;\n        })\n      | null)!;\n\n    resolvedForm.hass = this._hass;\n    this.updateFormData(resolvedForm);\n    resolvedForm.schema = [\n      { name: 'title', selector: { text: {} } },\n      {\n        name: 'device_id',\n        selector: {\n          device: { manufacturer: 'rail2mqtt', model: 'Departure Board' },\n        },\n      },\n    ];\n    resolvedForm.computeLabel = (schema: { name: string }) => {\n      if (schema.name === 'title') {\n        return 'Title (optional)';\n      }\n\n      return 'Device';\n    };\n    resolvedForm.computeHelper = (schema: { name: string }) => {\n      if (schema.name === 'device_id') {\n        return 'Select a rail2mqtt Departure Board device.';\n      }\n\n      return '';\n    };\n    if (!resolvedForm.hasAttribute('data-listener')) {\n      resolvedForm.setAttribute('data-listener', 'true');\n      resolvedForm.addEventListener('value-changed', (event) => {\n        const detail = (event as CustomEvent).detail as {\n          value?: { title?: string; device_id?: string };\n        };\n        const value = detail.value ?? {};\n\n        if (value.title !== (this._config?.title ?? '')) {\n          this.updateConfigValue('title', value.title ?? '');\n        }\n\n        if (value.device_id !== (this._config?.device_id ?? '')) {\n          this.updateDeviceFromDevice(value.device_id ?? '');\n        }\n      });\n    }\n  }\n}\n\ncustomElements.define('uk-rail-card', UkRailCard);\ncustomElements.define('uk-rail-card-editor', UkRailCardEditor);\n\n(window as { customCards?: Array<Record<string, unknown>> }).customCards =\n  (window as { customCards?: Array<Record<string, unknown>> }).customCards ||\n  [];\n\n(window as { customCards?: Array<Record<string, unknown>> }).customCards?.push({\n  type: 'uk-rail-card',\n  name: 'UK Rail Card',\n  description:\n    'Displays upcoming rail services with scheduled and estimated times.',\n});\n"],"names":[],"mappings":"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"}